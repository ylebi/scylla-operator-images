FROM registry.access.redhat.com/ubi9/podman:9.7@sha256:e1b2b62c9cf057b681169310b1d74c1d7051832e2c01f055d656bc34c304fd37

ENV GOPATH=/go \
    GOROOT=/usr/local/go

COPY ./download-file.sh /tmp/

RUN set -euExo pipefail && shopt -s inherit_errexit && \
    dnf install -y rsync git make tar gzip skopeo jq procps-ng && \
    dnf clean all && \
    case $(arch) in \
        x86_64) architecture="amd64" checksum="0442a8072c79c48f87ff1068ba2a40feda4c07b76ecd4ea0f6a6e9ae30020c39d06bd17ea0ebcedf48992526ecb7ddce8989119a5caca69d04364f5b7fca489b" ;; \
        aarch64) architecture="arm64" checksum="ccc64f89547ddf04dfd806319750c0e692f7e3980f2d8a06ea0161da8c86495487128af21347b5d65d760f9798855165d3509cd80050842e4d0693cdc9a7f08c" ;; \
        *) exit 42;; \
    esac && \
    /tmp/download-file.sh "https://go.dev/dl/go1.24.6.linux-${architecture}.tar.gz" "${checksum}" | tar -C /usr/local -xzf - && \
    ln -s /usr/local/go/bin/go /usr/local/bin/go && \
    go install github.com/mikefarah/yq/v4@v4.44.3 && \
    mv "$( go env GOPATH )/bin/yq" /usr/local/bin/ && \
    go install github.com/redhat-openshift-ecosystem/openshift-preflight/cmd/preflight@v1.14.1 && \
    mv "$( go env GOPATH )/bin/preflight" /usr/local/bin/ && \
    go install github.com/operator-framework/operator-manifest-tools@v0.11.0 && \
    mv "$( go env GOPATH )/bin/operator-manifest-tools" /usr/local/bin/ && \
    mkdir -p /go/src/k8s.io/ && \
    cd /go/src/k8s.io/ && \
    git clone --depth=1 --branch v1.33.3 https://github.com/kubernetes/kubernetes.git && \
    cd ./kubernetes && \
    make WHAT=cmd/kubectl && \
    mv /go/src/k8s.io/kubernetes/_output/bin/kubectl /usr/bin/ && \
    case $(arch) in \
        x86_64) architecture="amd64" checksum="835a5540974781620a8a31f91758bbcfbbf32eccf2f1fc4e4a690b52b0287176141225c3b8bc5010a22a1e0af1783d76747ff10d8e299c8cd304f6f9cdbb6776" ;; \
        aarch64) architecture="arm64" checksum="e6dc9265fdddf0a939ca6cacd5a7164396caf32478bc8960b93d2017044d58bc1594bef83546f22f698d9f7707a1ad25fe698c0280556fa6b3f6e3005fdee2da" ;; \
        *) exit 42;; \
    esac && \
    /tmp/download-file.sh "https://github.com/operator-framework/operator-registry/releases/download/v1.56.0/linux-${architecture}-opm" "${checksum}" | cat >/usr/local/bin/opm  && \
    chmod +x /usr/local/bin/opm && \
    case $(arch) in \
        x86_64) architecture="x86_64" checksum="6ea0bfb8029bb5d2b6f0d399eda51e0943d9d2bfebc72a00f714288972bd4509cc9531e5452fbdd85c6bd797046953e5cca9de74cb5905db64940e3ec36eaa1c" ;; \
        aarch64) architecture="aarch64" checksum="490daad1ca531f2a8a13e109cf985b81606b51c6ff3925bc7ca2a8f7fd5d22c1d5dbf0a75db920018c76079fab8802a08c507fa8aca4d430123271e4abd2be7c" ;; \
        *) exit 42;; \
    esac && \
    /tmp/download-file.sh "https://github.com/tektoncd/cli/releases/download/v0.43.0/tkn_0.43.0_Linux_${architecture}.tar.gz" "${checksum}" | tar -C /usr/local/bin -xzf - tkn && \
    chmod +x /usr/local/bin/tkn && \
    case $(arch) in \
        x86_64) architecture="amd64" checksum="813e82cf7a82a034d099476e1b423bbdd7c32fb36c5209a0fa74c20c58d2676fc06509fd4bf6f0019e146c3b3e8b5ce85d26878ce336e8eeb3c66aa9e7efe35b" ;; \
        aarch64) architecture="arm64" checksum="77b2bd072739c33671348d6dd3901adb1cd1dd46e94f3e5d20f71741450c27d3cb73289c82f610c486bc1414e1ab2b07a358ec651fca12d3c7139c1bbed99b07" ;; \
        *) exit 42;; \
    esac && \
    /tmp/download-file.sh "https://kind.sigs.k8s.io/dl/v0.31.0/kind-linux-${architecture}" "${checksum}" | cat >/usr/local/bin/kind  && \
    chmod +x /usr/local/bin/kind && \
    mkdir -p /go/src/github.com/operator-framework && \
    cd /go/src/github.com/operator-framework && \
    # TODO: replace to upstream once https://github.com/operator-framework/operator-sdk/pull/6978 is released \
    git clone --depth=1 --branch support-aggregated-clusterroles https://github.com/zimnx/operator-sdk.git && \
    cd ./operator-sdk && \
    make build && \
    mv /go/src/github.com/operator-framework/operator-sdk/build/operator-sdk /usr/local/bin/operator-sdk && \
    chmod +x /usr/local/bin/operator-sdk && \
    go clean -modcache && \
    go clean -cache && \
    rm -rf /go/src/ && \
    rm -rf /tmp/*

# Base image has all of the containers.conf settings set to "host" by default, but for our use case (running a kind cluster
# using rootless podman inside of a pod) we need:
# - UTS namespaces to be private so that kind can set nodes' hostnames
# - cgroups to be enabled so that kind nodes' kubelets can create pods with sub-cgroup limits
# Inspired by https://github.com/adelton/kind-in-pod.
RUN sed -i 's/utsns=.*/utsns="private"/; s/cgroups=.*/cgroups="enabled"/' /etc/containers/containers.conf
